<script type="text/javascript">
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawCharts);

  async function fetchTransactions() {
    try {
      const res = await fetch("/api/transactions");
      return await res.json();
    } catch (err) {
      console.error("Failed to load transactions from server:", err);
      return [];
    }
  }

  async function drawCharts() {
    const transactions = await fetchTransactions();
    drawPieChart(transactions);
    drawLineChart(transactions);
  }

  function drawPieChart(transactions) {
    let totals = {};
    transactions.forEach(t => {
      if (!totals[t.type]) totals[t.type] = 0;
      totals[t.type] += t.amount;
    });

    let chartData = [['Type', 'Amount']];
    for (let type in totals) {
      chartData.push([type, totals[type]]);
    }

    const data = google.visualization.arrayToDataTable(chartData);

    const options = {
      title: 'Transactions by Type',
      backgroundColor: '#1F1F1F',
      titleTextStyle: { color: '#C1C1C1' },
      legendTextStyle: { color: '#C1C1C1' }
    };

    const chart = new google.visualization.PieChart(document.getElementById('piechart'));
    chart.draw(data, options);
  }

  function drawLineChart(transactions) {
    let balance = 0;
    let chartData = [['Date', 'Balance ($)']];

    transactions.forEach((t) => {
      if (t.type === 'Funding') balance += t.amount;
      else balance -= t.amount;
      chartData.push([t.date, balance]);
    });

    const data = google.visualization.arrayToDataTable(chartData);

    const options = {
      title: 'Balance Over Time',
      curveType: 'function',
      legend: { position: 'bottom' },
      backgroundColor: '#1F1F1F',
      titleTextStyle: { color: '#C1C1C1' },
      legendTextStyle: { color: '#C1C1C1' },
      hAxis: { title: 'Date', textStyle: { color: '#C1C1C1' }, titleTextStyle: { color: '#C1C1C1' } },
      vAxis: { title: 'Balance ($)', textStyle: { color: '#C1C1C1' }, titleTextStyle: { color: '#C1C1C1' } }
    };

    const chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
    chart.draw(data, options);
  }

  setInterval(drawCharts, 1000);
</script>
